
âœ… PHASE 3A â€” CORE RUNTIME / LEDGER INTEGRATION

EXECUTION PROMPT (AUTHORITATIVE)

â¸»

CONTEXT (READ FULLY â€” NON-NEGOTIABLE)

You are executing Phase 3A of the WebWaka Modular Rebuild.

This phase introduces the Core Runtime / Ledger Integration Layer, which sits below all Suites and above infrastructure only.

This is a HEADLESS CORE MODULE.

ğŸš« NO UI
ğŸš« NO dashboards
ğŸš« NO demo data
ğŸš« NO pricing logic
ğŸš« NO incentives logic
ğŸš« NO payments execution
ğŸš« NO subscription state machines

This phase is foundational and cannot drift.

â¸»

SOURCE OF TRUTH (IMMUTABLE)
	â€¢	WebWaka Ecosystem Constitution v1.5+
	â€¢	Nigeria-first, offline-first, deterministic, multi-tenant
	â€¢	All previous phases (Core Control, Pricing, Incentives, Entitlements, Dashboard Control) are already complete and locked
	â€¢	Neon (Postgres) is the canonical relational substrate
	â€¢	All code must be pure, auditable, deterministic

â¸»

TARGET REPOSITORY (MUST BE CLONED FIRST)

ğŸ“¦ Repository:

changerplanet/webwaka-core-ledger

âš ï¸ MANDATORY
	â€¢	You MUST clone this repo before writing any code
	â€¢	If cloning fails â†’ STOP and report
	â€¢	All work happens on main
	â€¢	No branch protection
	â€¢	CI must fail loudly

â¸»

PLATFORM

ğŸ›  Execution Platform: Replit
ğŸ“¦ Language: TypeScript (Node.js 20)
ğŸ§ª Testing: Jest
ğŸ—„ Database: Neon (Postgres)

â¸»

OBJECTIVE

Implement the Core Ledger Runtime that provides:
	â€¢	Immutable, append-only financial/event ledger
	â€¢	Deterministic balance derivation
	â€¢	Auditable, replayable, tenant-isolated records
	â€¢	A single source of truth for ALL economic activity (pricing outputs, incentives outputs, payments outcomes later)

This module does NOT decide what to charge or reward â€” it only records what happened.

â¸»

REQUIRED DOMAIN CONCEPTS

1ï¸âƒ£ Ledger Account

Represents a logical account (wallet, clearing account, revenue bucket, etc.)

Fields (minimum):
	â€¢	accountId
	â€¢	tenantId
	â€¢	accountType
	â€¢	currency (NGN only)
	â€¢	metadata (JSON)
	â€¢	createdAt

â¸»

2ï¸âƒ£ Ledger Event (IMMUTABLE)

Append-only events that affect accounts.

Fields (minimum):
	â€¢	eventId
	â€¢	tenantId
	â€¢	accountId
	â€¢	direction (credit | debit)
	â€¢	amount (integer kobo)
	â€¢	currency (NGN)
	â€¢	sourceType (pricing | incentive | payment | adjustment | reversal)
	â€¢	sourceRef (string)
	â€¢	idempotencyKey
	â€¢	createdAt

ğŸš« NO UPDATE
ğŸš« NO DELETE

Corrections happen only via compensating events.

â¸»

3ï¸âƒ£ Derived Balance

Balances are:
	â€¢	NEVER stored
	â€¢	ALWAYS computed from events
	â€¢	Deterministic given event history

â¸»

REQUIRED PUBLIC APIs

openAccount(input)
recordEvent(input)
reverseEvent(input)
getAccountBalance(accountId, atTime?)
getAccountStatement(accountId, range?)
verifyLedgerIntegrity(tenantId)

All APIs MUST:
	â€¢	Require tenantId
	â€¢	Enforce NGN only
	â€¢	Be deterministic
	â€¢	Be side-effect free except persistence

â¸»

DATABASE REQUIREMENTS (NEON)

You MUST:
	â€¢	Define SQL schema for:
	â€¢	ledger_accounts
	â€¢	ledger_events
	â€¢	Enforce:
	â€¢	tenant isolation
	â€¢	idempotency via unique constraints
	â€¢	append-only behavior
	â€¢	No triggers that mutate data
	â€¢	Index for tenantId + accountId

â¸»

INVARIANTS (HARD LOCKED)

You MUST enforce and test:

1ï¸âƒ£ Append-only ledger
2ï¸âƒ£ No balance storage
3ï¸âƒ£ Idempotent event recording
4ï¸âƒ£ Tenant isolation (no cross-tenant reads)
5ï¸âƒ£ Deterministic replay
6ï¸âƒ£ Compensating reversals only
7ï¸âƒ£ NGN currency only

Violation of ANY invariant = FAIL.

â¸»

TESTING (MANDATORY)

You MUST include tests proving:
	â€¢	Two identical inputs â†’ identical ledger state
	â€¢	Duplicate idempotencyKey does NOT create duplicate events
	â€¢	Balance changes correctly after credit/debit
	â€¢	Reversal does NOT delete original event
	â€¢	Cross-tenant access throws error
	â€¢	Ledger integrity verification catches tampering

Coverage target: â‰¥80%

â¸»

MANIFEST & REGISTRY

Update:
	â€¢	module.manifest.json
	â€¢	class: core
	â€¢	capabilities:
	â€¢	ledger:account.open
	â€¢	ledger:event.record
	â€¢	ledger:event.reverse
	â€¢	ledger:balance.read
	â€¢	ledger:integrity.verify

NO enabling for tenants yet.

â¸»

STRICT PROHIBITIONS

âŒ No pricing calculations
âŒ No incentive calculations
âŒ No payment gateways
âŒ No wallets UI
âŒ No cron jobs
âŒ No background workers
âŒ No fake/demo values

â¸»

REQUIRED FINAL DELIVERABLE

Produce a Phase 3A Completion Report with:

A. Schema Summary

Tables, constraints, and invariants

B. API Summary

Methods, inputs, outputs

C. Test Proof

List of invariant-proving tests

D. Hard-Stop Proof

Explicit statement showing:

â€œAny Suite can emit a pricing/incentive result into the ledger and later derive balances and proofs deterministically.â€

â¸»

â›” HARD STOP

After completion:

â›” STOP
â›” DO NOT proceed to Phase 3B
â›” Await explicit authorization

â¸»

ACKNOWLEDGEMENT FORMAT (MANDATORY)

Reply only with:

â€œPhase 3A acknowledged. Cloning repo and proceeding exactly as instructed.â€

Then execute.